---
- name: Setting up workload
  debug:
    msg: "Setting up GitLab"

# - name: Setup Gitlab dependencies
#   include_tasks:
#     file: ./setup_janus_argocd.yml

- name: env
  env:
  - namespace: "backstage"
    companyname: "ACME Inc"
    gitopsnamespace: "janus-argocd"
    gitopsinfranamespace: "openshift-gitops"
    pipelinesnamespace: "janus-pipelines"
    vaultconfignamespace: "vault-config-operator"
    vaultnamespace: "vault"
    gitwebhooknamespace: "gitwebhook-operator"
    janusinstancename: "janus-dev"
    githubinfraorganization: "janus-idp"
    githubinfrarevision: "main"

- name: Determine Host
  shell: "oc cluster-info | head -n 1 | sed 's/^.*https...api//' | sed 's/.6443.*$//'"
  register: cluster_response

- name: Extract Cluster
  set_fact:
    cluster_host: "{{ cluster_response.stdout }}"

- name: Run Cert Manager Helm Chart
  with_items: "{{ env }}"
  kubernetes.core.helm:
    state: present
    name: cert-manager
    namespace: "openshift-operators"
    chart_ref: ~/demo-setup/charts/operator
    values_files: ["~/demo-setup/charts/operator/values-certmanager-operator.yaml"]

- name: Wait for Cert Manager to be Ready
  with_items: "{{ env }}"
  kubernetes.core.k8s_info:
    api_version:  cert-manager.io/v1
    kind: ClusterIssuer
  register: cm_crd
  until: cm_crd.api_found == true
  retries: 40
  delay: 5

- name: Pause until Cert Manager is Ready
  pause:
    seconds: 10

- name: Helm Dependency Update
  shell: "helm dep update"
  args:
    chdir: ~/demo-setup/charts/vault
  register: sso_admin_pwd_rsp

- name: Run Vault Helm Chart
  with_items: "{{ env }}"
  kubernetes.core.helm:
    state: present
    name: vault
    namespace: "{{ item.vaultnamespace }}"
    chart_ref: ~/demo-setup/charts/vault
    values:
      dns:
        zone: "{{ cluster_host[1:] }}"
    create_namespace: true

# Leave this as the last task in the playbook.
# --------------------------------------------
- name: workload tasks complete
  debug:
    msg: "Workload Tasks completed successfully."
  when: not silent|bool
